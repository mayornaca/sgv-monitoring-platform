{# Template para visualización del reporte en modal (legacy pattern) #}

{# Encabezado del reporte #}
<div class="mb-3 p-3 bg-light border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% set total_registros_report = 0 %}
            {% for row in data_table %}
                {% if row.incidente_r != '999999' %}
                    {% set total_registros_report = total_registros_report + 1 %}
                {% endif %}
            {% endfor %}
            <h5 class="mb-1">{{ rpt_title|default('Tiempos Recursos Externos - Accidentes') }}</h5>
            <p class="mb-0 text-muted">
                <strong>{{ human_params }}</strong>
                <span class="ms-3">|</span>
                <span class="ms-3"><i class="fas fa-list-ol me-1"></i>Total de registros: <strong>{{ total_registros_report }}</strong></span>
                <span class="ms-3">|</span>
                <span class="ms-3"><i class="fas fa-calendar me-1"></i>{{ "now"|date("d/m/Y H:i:s") }}</span>
            </p>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover table-sm table-bordered">
        <thead class="table-light">
            {# Fila 1: Agrupación de recursos #}
            <tr>
                <th class="text-center align-middle" colspan="4" rowspan="2">
                    <small>Información del Incidente</small>
                </th>
                <th class="text-center" colspan="3">Ambulancia externa</th>
                <th class="text-center" colspan="3">Bomberos</th>
                <th class="text-center" colspan="3">Carabineros</th>
                <th class="text-center" colspan="3">Servicio Médico Legal</th>
            </tr>
            {# Fila 2: "Tiempos asociados" para cada recurso #}
            <tr>
                <th class="text-center" colspan="3"><small>Tiempos asociados</small></th>
                <th class="text-center" colspan="3"><small>Tiempos asociados</small></th>
                <th class="text-center" colspan="3"><small>Tiempos asociados</small></th>
                <th class="text-center" colspan="3"><small>Tiempos asociados</small></th>
            </tr>
            {# Fila 3: Headers individuales #}
            <tr>
                <th class="text-center"><small># Incidente</small></th>
                <th class="text-center"><small>Tipo</small></th>
                <th class="text-center"><small>Eje</small></th>
                <th class="text-center"><small>PK</small></th>
                {# Ambulancia #}
                <th class="text-center" title="Desplazamiento"><small>Despl.</small></th>
                <th class="text-center" title="Respuesta"><small>Resp.</small></th>
                <th class="text-center" title="Trabajo"><small>Trab.</small></th>
                {# Bomberos #}
                <th class="text-center" title="Desplazamiento"><small>Despl.</small></th>
                <th class="text-center" title="Respuesta"><small>Resp.</small></th>
                <th class="text-center" title="Trabajo"><small>Trab.</small></th>
                {# Carabineros #}
                <th class="text-center" title="Desplazamiento"><small>Despl.</small></th>
                <th class="text-center" title="Respuesta"><small>Resp.</small></th>
                <th class="text-center" title="Trabajo"><small>Trab.</small></th>
                {# SML #}
                <th class="text-center" title="Desplazamiento"><small>Despl.</small></th>
                <th class="text-center" title="Respuesta"><small>Resp.</small></th>
                <th class="text-center" title="Trabajo"><small>Trab.</small></th>
            </tr>
        </thead>
        <tbody>
            {% for row in data_table %}
                {% if row.incidente_r != '999999' %}
                    {# Datos normales #}
                    <tr>
                        <td class="text-center"><small>{{ row.incidente_r }}</small></td>
                        <td class="text-start"><small>{{ row.desc_tipo_evento_r }}</small></td>
                        <td class="text-center"><small>{{ row.eje_r }}</small></td>
                        <td class="text-center"><small>{{ row.pk_r }}</small></td>
                        {# Ambulancia #}
                        <td class="text-center"><small>{{ row.a_time_1_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.a_time_2_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.a_time_3_a_4_r }}</small></td>
                        {# Bomberos #}
                        <td class="text-center"><small>{{ row.b_time_1_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.b_time_2_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.b_time_3_a_4_r }}</small></td>
                        {# Carabineros #}
                        <td class="text-center"><small>{{ row.c_time_1_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.c_time_2_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.c_time_3_a_4_r }}</small></td>
                        {# SML #}
                        <td class="text-center"><small>{{ row.s_time_1_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.s_time_2_a_3_r }}</small></td>
                        <td class="text-center"><small>{{ row.s_time_3_a_4_r }}</small></td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
        {% set promediosRow = null %}
        {% for row in data_table %}
            {% if row.incidente_r == '999999' %}
                {% set promediosRow = row %}
            {% endif %}
        {% endfor %}

        {% if promediosRow %}
        <tfoot class="table-secondary">
            {# Fila separadora #}
            <tr>
                <td colspan="16">&nbsp;</td>
            </tr>
            {# Fila de promedios #}
            <tr class="fw-bold">
                <th class="text-end" colspan="4">PROMEDIOS:&nbsp;&nbsp;&nbsp;</th>
                {# Ambulancia #}
                <td class="text-center"><small>{{ promediosRow.a_time_1_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.a_time_2_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.a_time_3_a_4_r }}</small></td>
                {# Bomberos #}
                <td class="text-center"><small>{{ promediosRow.b_time_1_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.b_time_2_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.b_time_3_a_4_r }}</small></td>
                {# Carabineros #}
                <td class="text-center"><small>{{ promediosRow.c_time_1_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.c_time_2_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.c_time_3_a_4_r }}</small></td>
                {# SML #}
                <td class="text-center"><small>{{ promediosRow.s_time_1_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.s_time_2_a_3_r }}</small></td>
                <td class="text-center"><small>{{ promediosRow.s_time_3_a_4_r }}</small></td>
            </tr>
        </tfoot>
        {% endif %}
    </table>
</div>

<style>
    /* Estilos compactos para modal */
    #report_trea_table_container table {
        font-size: 0.85rem;
    }
    #report_trea_table_container th,
    #report_trea_table_container td {
        padding: 4px;
        vertical-align: middle;
    }
    #report_trea_table_container thead th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>
