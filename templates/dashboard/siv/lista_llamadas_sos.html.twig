{% extends '@EasyAdmin/page/content.html.twig' %}

{% block page_title %}
    Lista de Llamadas SOS
{% endblock %}

{% block page_content %}
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="page-header mb-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h2">
                        <i class="fas fa-phone-alt"></i> Lista de Llamadas SOS
                    </h1>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-info me-2">
                        Total registros: <span class="badge bg-white text-dark">{{ pagination.getTotalItemCount }}</span>
                    </button>
                    <button id="toggle_filters" type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#filter-panel">
                        <i class="fas fa-filter"></i> Filtros & Opciones
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters Panel -->
        <div id="filter-panel" class="collapse mb-4">
            <div class="card">
                <div class="card-body">
                    <form id="report_filters" method="get" action="{{ path('admin_lista_llamadas_sos') }}">
                        <!-- Hidden field for ci (carga inicial) -->
                        <input type="hidden" name="ci" value="1">
                        <div class="row">
                            <!-- Date Filters -->
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="fechaInicio" class="form-label">Fecha de inicio</label>
                                    <div class="input-group">
                                        <input type="text" id="fechaInicio" name="fechaInicio"
                                               class="form-control datetime-picker"
                                               value="{{ app.request.get('fechaInicio') }}"
                                               placeholder="DD-MM-YYYY HH:mm:ss">
                                        <span class="input-group-text">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="fechaTermino" class="form-label">Fecha de término</label>
                                    <div class="input-group">
                                        <input type="text" id="fechaTermino" name="fechaTermino"
                                               class="form-control datetime-picker"
                                               value="{{ app.request.get('fechaTermino') }}"
                                               placeholder="DD-MM-YYYY HH:mm:ss">
                                        <span class="input-group-text">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- SOS Filter and Page Size -->
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="filterSos" class="form-label">Filtro de poste SOS</label>
                                    <input type="text" class="form-control" id="filterSos" name="filterSos"
                                           value="{{ app.request.get('filterSos') }}"
                                           placeholder="Nombre SOS">
                                </div>
                                <div class="mb-3">
                                    <label for="pageSize" class="form-label">Filas por página</label>
                                    <select class="form-select" id="pageSize" name="pageSize">
                                        {% set currentPageSize = app.request.get('pageSize', 20) %}
                                        {% for size in [10, 20, 50, 100, 500, 1000] %}
                                            <option value="{{ size }}" {% if currentPageSize == size %}selected{% endif %}>{{ size }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Export Options -->
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label d-block">Opciones de exportación</label>
                                    <div class="btn-group-vertical w-100" role="group">
                                        <a href="{{ path('admin_lista_llamadas_sos_export_excel') ~ '?' ~ app.request.queryString }}"
                                           class="btn btn-success">
                                            <i class="fas fa-file-excel"></i> Exportar Excel
                                        </a>
                                        <a href="{{ path('admin_lista_llamadas_sos_export_pdf') ~ '?' ~ app.request.queryString }}"
                                           class="btn btn-danger" target="_blank">
                                            <i class="fas fa-file-pdf"></i> Exportar PDF
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label d-block">&nbsp;</label>
                                    <button type="submit" class="btn btn-warning w-100">
                                        <i class="fas fa-play-circle"></i> Aplicar Filtros
                                    </button>
                                    <a href="{{ path('admin_lista_llamadas_sos') }}" class="btn btn-link w-100 mt-2">
                                        Limpiar filtros
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="sosTable" class="table table-striped table-hover"
                           data-toggle="table"
                           data-search="true"
                           data-show-refresh="true"
                           data-show-columns="true"
                           data-show-fullscreen="true"
                           data-show-export="true"
                           data-pagination="false">
                        <thead>
                            <tr>
                                <th data-sortable="true">Poste</th>
                                <th data-sortable="true">Eje</th>
                                <th data-sortable="true">Calzada</th>
                                <th data-sortable="true">Km</th>
                                <th data-sortable="true">Fecha Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for llamada in pagination %}
                                <tr>
                                    <td>{{ llamada.sos }}</td>
                                    <td>{{ llamada.eje }}</td>
                                    <td>{{ llamada.calzada }}</td>
                                    <td class="text-center">{{ llamada.km|number_format(1, ',', '.') }}</td>
                                    <td class="text-center">
                                        {% if llamada.fechaUtc %}
                                            {{ llamada.fechaUtc|date('d-m-Y H:i:s') }}
                                        {% else %}
                                            {{ llamada.fechaHora }}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No se encontraron llamadas SOS</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="navigation mt-3">
                    {{ knp_pagination_render(pagination) }}
                </div>
            </div>
        </div>

        <!-- Footer with Logos -->
        <div class="row mt-4 align-items-center">
            <div class="col-md-4">
                <img src="/images/concessions/HCSQELGZDdo.png" alt="Concesionaria" class="img-fluid" style="max-height: 65px;">
            </div>
            <div class="col-md-4 text-center">
                <p class="mb-0">Sociedad Concesionaria Costanera Norte</p>
            </div>
            <div class="col-md-4 text-end">
                <img src="/images/coordinacion_concesiones_obras_publicas.jpg" alt="MOP" class="img-fluid" style="max-height: 95px;">
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <!-- Bootstrap Table CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.2/dist/bootstrap-table.min.css">
    <!-- Tempus Dominus CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6/dist/css/tempus-dominus.min.css">

    <style>
        .page-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1rem;
        }
        .table th {
            background-color: #f4f6f9;
            font-weight: 600;
        }
        .datetime-picker {
            background-color: white !important;
        }
        #filter-panel {
            transition: all 0.3s ease;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- Bootstrap Table JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.2/dist/bootstrap-table.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.2/dist/locale/bootstrap-table-es-ES.min.js"></script>
    <!-- Tempus Dominus JS -->
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6/dist/js/tempus-dominus.min.js"></script>
    <!-- Popper.js required for Tempus Dominus -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap Table
            $('#sosTable').bootstrapTable({
                locale: 'es-ES',
                search: true,
                showRefresh: true,
                showColumns: true,
                showFullscreen: true,
                clickToSelect: true,
                toolbar: '#toolbar'
            });

            // Initialize DateTime Pickers
            const tempusDominus = window.tempusDominus;
            if (tempusDominus) {
                const options = {
                    display: {
                        components: {
                            calendar: true,
                            date: true,
                            month: true,
                            year: true,
                            decades: true,
                            clock: true,
                            hours: true,
                            minutes: true,
                            seconds: true
                        },
                        icons: {
                            time: 'fas fa-clock',
                            date: 'fas fa-calendar',
                            up: 'fas fa-arrow-up',
                            down: 'fas fa-arrow-down',
                            previous: 'fas fa-chevron-left',
                            next: 'fas fa-chevron-right',
                            today: 'fas fa-calendar-check',
                            clear: 'fas fa-trash',
                            close: 'fas fa-times'
                        }
                    },
                    localization: {
                        locale: 'es',
                        format: 'dd-MM-yyyy HH:mm:ss'
                    }
                };

                // Initialize fecha inicio
                if (document.getElementById('fechaInicio')) {
                    new tempusDominus.TempusDominus(document.getElementById('fechaInicio'), options);
                }

                // Initialize fecha término
                if (document.getElementById('fechaTermino')) {
                    new tempusDominus.TempusDominus(document.getElementById('fechaTermino'), options);
                }
            }

            // Auto-collapse filter panel after 3 seconds
            setTimeout(function() {
                const filterPanel = document.getElementById('filter-panel');
                if (filterPanel && filterPanel.classList.contains('show')) {
                    bootstrap.Collapse.getInstance(filterPanel)?.hide();
                }
            }, 3000);
        });
    </script>
{% endblock %}
