<div>
	<div id="ajax_edit_popup_container_render" class="card mb-1">
{#		<div class="card-header">#}
{#			<h3>#}
{#				{% if permiso.id %}Editar{% else %}Crear{% endif %} Permiso de Trabajo#}
{#				<span class="badge bg-info float-end" style="font-size: 28px;">#{{ permiso.id|default('NUEVO') }}</span>#}
{#			</h3>#}
{#		</div>#}
		<div class="card-body py-2 px-3">
			<div>
				<div id="vertical_form_overflow" class="row vertical_form_overflow">
					<div class="collapse show">
						<div class="card">
							<div class="card-body">
								<div id="toolbar1" class="enterleave">
									<button id="frm_edit_reg_save" type="button" class="btn btn-sm btn-success" {% if permiso.estado == 5 %}disabled{% endif %}>
										<i class="fas fa-save" aria-hidden="true"></i> Guardar
									</button>
									<button type="button" class="btn btn-sm btn-danger float-end" id="btn_close_edit_popup">
										<i class="fas fa-times" aria-hidden="true"></i> Cerrar
									</button>
								</div>
							</div>
						</div>
					</div>
					<h4 class="text-danger"></h4>

					<input type="hidden" id="frm_edit_reg-id" name="frm_edit_reg[id]" disabled="disabled" value="{{ permiso.id|default('') }}">
					<div class="mb-2 col-sm-8">
						<label for="frm_edit_reg-titulo" class="form-label small">Título</label>
						<input type="text" id="frm_edit_reg-titulo" class="form-control form-control-sm requerido_inicial " placeholder="Título" maxlength="50" value="{{ permiso.titulo|default('') }}" {% if permiso.estado == 5 %}disabled{% endif %}>
						<span class="text-danger"></span>
					</div>

					<div class="mb-2 col-sm-4">
						<label class="form-label small" for="frm_edit_reg-estado">Estado</label>
						<select class="selectpicker"  id="frm_edit_reg-estado" data-live-search="true" disabled title="Nuevo">
						</select>
					</div>

					<div class="mb-2 col-sm-12">
						<label for="frm_edit_reg-descripcion_trabajo" class="form-label small">Descripción</label>
						<input type="text" id="frm_edit_reg-descripcion_trabajo" class="form-control form-control-sm requerido_inicial" placeholder="Descripción" maxlength="250" value="{{ permiso.descripcion_trabajo|default('') }}" {% if permiso.estado == 5 %}disabled{% endif %}>
						<span class="text-danger"></span>
					</div>

					<div class="row col-sm-12">
						<div class="mb-2 col-sm-6">
							<label for="frm_edit_reg-fechaInicio" class="form-label small">Fecha de inicio </label>
							<div class="input-group input-group-sm" id="dtp_fer_FechaInicio">
								<input autocomplete="false" type="text" id="frm_edit_reg-fechaInicio" class="form-control" placeholder="Fecha de inicio" value="{{ permiso.fechahora_inicio_trabajo|default('') }}" {% if permiso.estado == 5 %}disabled{% endif %}>
								<span class="input-group-text">
									<i class="fas fa-calendar"></i>
								</span>
							</div>
						</div>
						<div class="mb-2 col-sm-6">
							<label for="frm_edit_reg-fechaTermino" class="form-label small">Fecha de término </label>
							<div class="input-group input-group-sm" id="dtp_fer_FechaTermino">
								<input type="text" id="frm_edit_reg-fechaTermino" class="form-control" placeholder="Fecha de término" value="{{ permiso.fechahora_fin_trabajo|default('') }}" {% if permiso.estado == 5 %}disabled{% endif %}>
								<span class="input-group-text">
									<i class="fas fa-calendar"></i>
								</span>
							</div>
						</div>
					</div>
					<div class="mb-2 col-sm-6">
						<label class="form-label small" for="frm_edit_reg-id_empresa_solicitante">Empresa Solicitante</label>
						<div class="input-group input-group-sm">
							<select class="selectpicker requerido_inicial"  id="frm_edit_reg-id_empresa_solicitante" data-live-search="true" title="Seleccione" {% if permiso.estado == 5 %}disabled{% endif %}>
                                {% for es in arr_empresas %}
								<option value="{{ es.id }}" {% if (permiso.id_empresa_solicitante|default('')) == (es.id|default('')) %}selected="selected"{% endif %}>{{ es.nombre }}</option>
                                {% endfor %}
							</select>
							<span class="input-group-text {% if permiso.estado != 5 %}cursor-pointer{% else %}opacity-50{% endif %}" id="addCompany" {% if permiso.estado == 5 %}style="cursor:not-allowed;"{% endif %}>
								<i class="fas fa-plus-circle" aria-hidden="true"></i>
							</span>
						</div>
					</div>

					<div class="mb-2 col-sm-6">
						<label class="form-label small" for="frm_edit_reg-id_lider_trabajo_solicitante">Responsable Empresa Solicitante</label>
						<div class="input-group input-group-sm">
							<select class="selectpicker requerido_inicial"  id="frm_edit_reg-id_lider_trabajo_solicitante" data-live-search="true" title="Seleccione" {% if permiso.estado == 5 %}disabled{% endif %}>
                                {% for res in arr_personas %}
								<option value="{{ res.id }}" {% if (permiso.id_lider_trabajo_solicitante|default('')) == (res.id|default('')) %}selected="selected"{% endif %}>RUT: {{ res.rut }} | {{ res.nombres }} {{ res.apellidos }}</option>
                                {% endfor %}
							</select>
							<span class="input-group-text {% if permiso.estado != 5 %}cursor-pointer{% else %}opacity-50{% endif %}" id="addInternalExternalStaff" {% if permiso.estado == 5 %}style="cursor:not-allowed;"{% endif %}>
								<i class="fas fa-user-plus" aria-hidden="true"></i>
							</span>
						</div>
					</div>
					<div class="mb-2 col-sm-12">
						<label class="form-label small" for="frm_edit_reg-id_autorizador">Responsable de Trabajos (CN / Gesvial)</label>
						<div class="input-group input-group-sm">
							<select class="selectpicker requerido_inicial"  id="frm_edit_reg-id_autorizador" data-live-search="true" title="Seleccione" {% if permiso.estado == 5 %}disabled{% endif %}>
                                {% for res in arr_personas %}
                                    {% if res.id|first|lower == 'i' and res.autoriza_ot %}
										<option value="{{ res.id }}" {% if (permiso.id_autorizador|default('')) == (res.id|default('')) %}selected="selected"{% endif %}>RUT: {{ res.rut }} | {{ res.nombres }} {{ res.apellidos }} </option>
                                    {% endif %}
                                {% endfor %}
							</select>
							<span class="input-group-text {% if permiso.estado != 5 %}cursor-pointer{% else %}opacity-50{% endif %}" id="addStaffAutorizador" {% if permiso.estado == 5 %}style="cursor:not-allowed;"{% endif %}>
								<i class="fas fa-user-plus" aria-hidden="true"></i>
							</span>
						</div>
					</div>
					<div class="mb-2 col-sm-7">
						<label class="form-label small" for="frm_edit_reg-id_ubicacion">Ubicación</label>
						<div class="input-group input-group-sm">
							<select class="selectpicker requerido_inicial"  id="frm_edit_reg-id_ubicacion" data-live-search="true" title="Seleccione" {% if permiso.estado == 5 %}disabled{% endif %}>
                                {% for res in arr_ub %}
								<option value="{{ res.id }}" {% if (permiso.id_ubicacion|default('')) == (res.id|default('')) %}selected="selected"{% endif %}>{{ res.nombre }}</option>
                                {% endfor %}
							</select>
							<span class="input-group-text {% if permiso.estado != 5 %}cursor-pointer{% else %}opacity-50{% endif %}" id="addLocation" {% if permiso.estado == 5 %}style="cursor:not-allowed;"{% endif %}>
								<i class="fas fa-plus-circle" aria-hidden="true"></i>
							</span>
						</div>
					</div>

					<div class="mb-2 col-sm-5">
						<label class="form-label small">Gestión de Archivos</label>
						<div class="btn-group col-sm-12">
							<button type="button" id="btn_adjuntar_archivos" class="btn btn-sm btn-info col-sm-6" {% if permiso.estado == 5 %}disabled{% endif %}>
								<i class="fas fa-cloud-upload" aria-hidden="true"></i> Adjuntar Archivo
							</button>
							<button type="button" id="btn_ver_archivos" class="btn btn-sm btn-success col-sm-6">
								<i class="fas fa-folder-open" aria-hidden="true"></i> Ver Archivos
							</button>
						</div>
					</div>
					<div class="tabbable-panel">
						<div class="tabbable-line">
							<ul class="nav nav-tabs" role="tablist">
								<li class="nav-item" role="presentation">
									<button class="nav-link active" id="tab-observaciones" data-bs-toggle="tab" data-bs-target="#tab_default_1" type="button" role="tab">
										Observaciones
									</button>
								</li>
								<li class="nav-item" role="presentation">
									<button class="nav-link" id="tab-archivos" data-bs-toggle="tab" data-bs-target="#tab_default_2" type="button" role="tab">
										Archivos
									</button>
								</li>
							</ul>
							<div class="tab-content mt-2">
								<div class="tab-pane fade show active" id="tab_default_1" role="tabpanel">
									<div class="mb-2 col-sm-12">
										<label for="frm_edit_reg-observaciones" class="form-label small">Requerimientos y Observaciones Adicionales</label>
										<textarea id="frm_edit_reg-observaciones" class="form-control" placeholder="Observaciones" rows="4" {% if permiso.estado == 5 %}disabled{% endif %}></textarea>
										<span class="text-danger"></span>
									</div>
								</div>
								<div class="tab-pane fade" id="tab_default_2" role="tabpanel">
									<h5 class="mb-2"><i class="fas fa-list"></i> Archivos Adjuntos</h5>

									<div id="toolbar_tbl_attached_files" class="mb-2">
										<button type="button" id="btn_delete_selected_files" class="btn btn-secondary btn-sm" onclick="deleteAttachmentFile()" {% if permiso.estado == 5 %}disabled{% endif %}>
											<i class="fas fa-trash"></i> Eliminar
										</button>
										<button type="button" id="btn_download_selected_files" class="btn btn-primary btn-sm" onclick="downloadAttachedFiles()">
											<i class="fas fa-download"></i> Descargar
										</button>
										<button type="button" id="btn_load_files" class="btn btn-secondary btn-sm" onclick="loadAttachedFileObjArr()">
											<i class="fas fa-sync-alt"></i> Recargar
										</button>
									</div>
									<table class="table table-striped table-hover bootstrapTable"
										   id="tbl_attached_files"
										   data-toolbar="#toolbar_tbl_attached_files"
										   data-search="true"
										   data-show-columns="true"
										   data-id-field="file_id"
										   data-click-to-select="false"
									>
										<thead>
										<tr>
											<th data-checkbox="true" data-sortable="false"></th>
											<th data-field="file_id">Id</th>
											<th data-field="file_index">#</th>
											<th data-field="path" data-visible="false">Ruta</th>
											<th data-field="file_name_original">Nombre Archivo</th>
											<th data-field="create_at">Fecha de carga</th>
										</tr>
										</thead>
										<tbody>
										</tbody>
									</table>
									<!-- Widget de Upload Bootstrap-Fileinput -->
									<div class="mb-3">
										{% include 'dashboard/siv/permisos_trabajos/file_upload.html.twig' with {
											'permiso_trabajo_id': permiso.id|default(null),
											'attached_files': permiso.attached_files|default('')
										} %}
									</div>
									<div class="mb-2 col-sm-12 d-none">
										<label for="frm_edit_reg_attached_files" class="form-label small">Attachment files</label>
										<textarea id="frm_edit_reg_attached_files" class="form-control" placeholder="attached_files" rows="4">{{ permiso.attached_files|default('') }}</textarea>
										<span class="text-danger"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Scripts migrados a lista_permisos_trabajos.html.twig con event delegation -->
	</div>
</div>
