{# Formulario AJAX Proveedor/Empresa Solicitante - Bootstrap 5 #}
<div>
    <div id="ajax_frm_add" class="form-group col-sm-12 stop-propagation">
        <div class="row">
            <div id="frm_new_supplier">
                <form class="form needs-validation" id="frm_add_supplier" novalidate>
                    <input id="frm_new_supplier_id" class="d-none" value="-1">

                    <div class="row g-3 mb-3">
                        <div class="form-group col-sm-6 mb-3">
                            <label for="frm_new_supplier_razon_social">Razón Social *</label>
                            <input type="text" class="form-control control_new_supplier"
                                   id="frm_new_supplier_razon_social"
                                   name="frm_new_supplier_razon_social"
                                   placeholder="Razón Social" value="" required>
                            <div class="invalid-feedback">Por favor ingrese la razón social.</div>
                        </div>
                        <div class="form-group col-sm-6 mb-3">
                            <label for="frm_new_supplier_rut_proveedor">RUT *</label>
                            <input type="text" class="form-control control_new_supplier"
                                   id="frm_new_supplier_rut_proveedor"
                                   name="frm_new_supplier_rut_proveedor"
                                   placeholder="RUT" value="" required
                                   pattern="[\d]{1,2}\.?[\d]{3}\.?[\d]{3}-?[\dkK]{1}"
                                   title="Formato RUT: 11.111.111-1">
                            <div class="invalid-feedback">Por favor ingrese un RUT válido.</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {# Botones del formulario #}
        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-success stop-propagation" id="btn_set_supplier">
                <i class="fa fa-check"></i> Crear y seleccionar
            </button>
            <button class="btn btn-secondary ms-auto stop-propagation" id="btn_cancel_supplier">
                <i class="fa fa-times"></i> Cerrar
            </button>
        </div>

        <script>
            (function() {
                var frm_new_supplier_id = $("#frm_new_supplier_id"),
                    frm_new_supplier_razon_social = $("#frm_new_supplier_razon_social"),
                    frm_new_supplier_rut_proveedor = $("#frm_new_supplier_rut_proveedor"),
                    btn_set_supplier = $("#btn_set_supplier"),
                    selTarget = $("#{{ selTarget|default('') }}");

                // Cerrar popup
                $("#btn_cancel_supplier").on('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (typeof closeAjaxFrmPopup === 'function') {
                        closeAjaxFrmPopup();
                    }
                });

                // Guardar proveedor
                btn_set_supplier.on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Validación Bootstrap 5 nativa
                    var form = document.getElementById('frm_add_supplier');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }
                    form.classList.add('was-validated');

                    var data = {
                        razon_social: frm_new_supplier_razon_social.val(),
                        rut_proveedor: frm_new_supplier_rut_proveedor.val()
                    };

                    $.ajax({
                        url: "{{ path('proveedor_create_ajax') }}",
                        type: 'POST',
                        data: data,
                        dataType: "json",
                        success: function(response) {
                            if (response.mensaje_success) {
                                showNotification(response.mensaje_success, {className: 'success'});

                                // Actualizar select directamente por ID (patrón legacy funcional)
                                if (response.idProveedor) {
                                    var optionText = data.razon_social;
                                    var optionValue = 'p-' + response.idProveedor;

                                    // Actualizar select de empresa solicitante (siempre existe)
                                    var $selectEmpresa = $("#frm_edit_reg-id_empresa_solicitante");
                                    if ($selectEmpresa.length && $selectEmpresa.find('[value="' + optionValue + '"]').length === 0) {
                                        $selectEmpresa.append(new Option(optionText, optionValue));
                                    }

                                    // Seleccionar el nuevo valor
                                    $selectEmpresa.val(optionValue).trigger('change');

                                    // Refresh TODOS los selectpickers
                                    $('.selectpicker').selectpicker('refresh');
                                }

                                if (typeof closeAjaxFrmPopup === 'function') {
                                    closeAjaxFrmPopup();
                                }
                            } else if (response.mensaje_error) {
                                showNotification(response.mensaje_error, {className: 'error'});
                            }
                        },
                        error: function() {
                            showNotification('Ha ocurrido un error al procesar la solicitud', {className: 'error'});
                        }
                    });
                });
            })();
        </script>
    </div>
</div>
