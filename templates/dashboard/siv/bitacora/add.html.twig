<div>
	<div id="ajax_edit_popup_container_render">
		<h4 class="mb-3">Crear registro de bitácora</h4>
		<div>
			<div>
				<div class="row vertical_form_overflow">
					<div>
						<div class="card mb-3">
							<div class="card-body">
								<div id="toolbar1" class="d-flex justify-content-between">
									<button id="frm_edit_reg_save" class="btn btn-success">
										<i class="fas fa-save"></i> Guardar
									</button>
									<button class="btn btn-secondary" id="btn_close_edit_popup">
										<i class="fas fa-times"></i> Cerrar
									</button>
								</div>
							</div>
						</div>
					</div>
					<h4 class="text-danger"></h4>

					<input type="hidden" id="frm_edit_reg-id" name="frm_edit_reg[id]" disabled="disabled" value="-1">

					<div class="tabbable-panel">
						<div class="tabbable-line">
							<ul class="nav nav-tabs" role="tablist">
								<li class="nav-item" role="presentation">
									<button class="nav-link active" id="tab-observaciones" data-bs-toggle="tab" data-bs-target="#tab_default_1" type="button" role="tab" aria-controls="tab_default_1" aria-selected="true">
										Observaciones
									</button>
								</li>
								<li class="nav-item d-none" role="presentation">
									<button class="nav-link" id="tab-archivos" data-bs-toggle="tab" data-bs-target="#tab_default_2" type="button" role="tab" aria-controls="tab_default_2" aria-selected="false">
										Archivos
									</button>
								</li>
							</ul>
							<div class="tab-content mt-3">
								<div class="tab-pane fade show active" id="tab_default_1" role="tabpanel" aria-labelledby="tab-observaciones">
									<div class="form-group col-sm-12">
										<label for="frm_edit_reg-observaciones">Escriba un registro de bitácora</label>
										<textarea id="frm_edit_reg-observaciones" class="form-control requerido_inicial" placeholder="" style="min-height: 500px;"></textarea>
										<span class="text-danger"></span>
									</div>
								</div>
								<div class="tab-pane fade" id="tab_default_2" role="tabpanel" aria-labelledby="tab-archivos">
									<div id="toolbar_tbl_attached_files" class="mb-3">
										<button id="btn_delete_selected_files" class="btn btn-danger btn-sm" onclick="deleteAttachmentFile();">
											<i class="fas fa-trash"></i> Eliminar
										</button>
										<button id="btn_load_files" class="btn btn-secondary btn-sm">
											<i class="fas fa-sync-alt"></i> Recargar
										</button>
									</div>
									<table class="table table-striped table-hover bootstrapTable"
										   id="tbl_attached_files"
										   data-toolbar="#toolbar_tbl_attached_files"
										   data-search="true"
										   data-show-columns="true"
										   data-id-field="file_id"
										   data-click-to-select="false"
									>
										<thead>
										<tr>
											<th data-checkbox="true" data-sortable="false"></th>
											<th data-field="file_id">Id</th>
											<th data-field="file_index">#</th>
											<th data-field="path" data-visible="false">Ruta</th>
											<th data-field="file_name_original">Nombre Archivo</th>
											<th data-field="create_at">Fecha de carga</th>
										</tr>
										</thead>
										<tbody>
										</tbody>
									</table>
									<div class="form-group col-sm-12 hidden">
										<label for="frm_edit_reg_attached_files">Attachment files</label>
										<textarea id="frm_edit_reg_attached_files" class="form-control" placeholder="attached_files" style="min-height: 100px;"></textarea>
										<span class="text-danger"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script>
            /*** table attachment files ***/
            var $tbl_attached_files = $('#tbl_attached_files');
            var $btn_load_files = $('#btn_load_files');
            var $frm_edit_reg_attached_files = $("#frm_edit_reg_attached_files");
            var attachedFileObjArr = [];

            function loadAttachedFileObjArr() {
                if(!!$frm_edit_reg_attached_files.val()){
                    attachedFileObjArr = JSON.parse($frm_edit_reg_attached_files.val());
                    $tbl_attached_files.bootstrapTable({data: attachedFileObjArr});
                }
            }

            $(function() {
                $btn_load_files.click(function () {
                    loadAttachedFileObjArr()
                });
            });

            $('#btn_close_edit_popup').click(function () {
                closeAjaxFrmEditPopup();
            });

            $("#frm_edit_reg_save").click(function() {
                saveReg();
                return true;
            });

            function saveReg() {
                if(validaRequeridosIniciales()){
                    $.notify(
                        "Todo bien! se está enviando la información...",
                        {  style: 'custom', className: 'success', position:"top right" }
                    );
                    var path_url = "{{ path('admin_siv_dashboard_bitacora_scada') }}";

                    var data = {
                        action: 'insert',
                        id: $("#frm_edit_reg-id").val(),
                        concesionaria: '22',
                        observaciones: $("#frm_edit_reg-observaciones").val(),
                        attached_files: $frm_edit_reg_attached_files.val(),
                        token: "{{ csrf_token('insert-bs') }}"
                    };

                    $.ajax({
                        url : path_url,
                        type: 'POST',
                        data: data,
                        dataType: "json",
                        success: function(response) {
                            if(response.msg){
                                $.notify(
                                    response.msg,
                                    {style: 'bootstrap', className: response.msg_type, position: "top right"}
                                );
                                closeAjaxFrmEditPopup();
                                getBinacleScadaData();
                            }
                            else{
                                $.notify(
                                    "Ha ocurrido un error al intentar procesar los datos. Reintente la operación.",
                                    {style: 'bootstrap', className: 'error', position: "top right"}
                                );
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error AJAX:', status, error);
                            console.error('Response:', xhr.responseText);
                            $.notify(
                                "Ha ocurrido un error al intentar procesar los datos. Reintente la operación.",
                                {style: 'bootstrap', className: 'error', position: "top right"}
                            );
                        }
                    });
                    return false;
                }
                else {
                    $.notify(
                        "Se encontraron errores en los datos ingresados, por favor verifique la información e intente nuevamente.",
                        {  style: 'bootstrap', className: 'error', position:"top right" }
                    );
                    return false;
                }
            }
		</script>
	</div>
</div>
