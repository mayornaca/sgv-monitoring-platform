{% extends '@EasyAdmin/page/content.html.twig' %}

{% block page_title %}Bitácora SCADA{% endblock %}

{% block head_stylesheets %}
    {{ parent() }}
    <style>
        .btn-group.stick-top.go-to-graphic.affix {
            top: 73px;
            left: 1px;
            z-index: 1000;
        }
        .bootstrap-table.fullscreen .fixed-table-toolbar {
            background: #333;
        }
        .bg-white {
            background-color: rgba(255, 255, 255, 0.02) !important;
        }
        .table>thead>tr>th {
            vertical-align: middle;
        }
        .severity-high {
            background-color: #dc3545;
            color: white;
        }
        .severity-medium {
            background-color: #ffc107;
            color: black;
        }
        .severity-low {
            background-color: #28a745;
            color: white;
        }
    </style>
{% endblock %}

{% block page_content %}
    <div class="container-fluid">
        <h1 class="h2 mb-3">
            <i class="fas fa-book"></i> Bitácora SCADA
        </h1>

        <!-- Panel de Filtros -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">
                    Filtros & Opciones
                    <button type="button" class="btn btn-sm btn-secondary float-end" data-bs-toggle="collapse" data-bs-target="#filter-panel">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div id="filter-panel" class="collapse show">
                <div class="card-body">
                    <form id="report_params" method="get" action="">
                        <input type="hidden" value="1" id="ci" name="ci">

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="fechaInicio" class="form-label">Fecha de inicio</label>
                                    <div class="input-group">
                                        <input type="text" id="fechaInicio" name="fechaInicio"
                                               class="form-control" placeholder="DD-MM-YYYY HH:mm:ss"
                                               value="{{ fechaInicio }}">
                                        <span class="input-group-text">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="fechaTermino" class="form-label">Fecha de término</label>
                                    <div class="input-group">
                                        <input type="text" id="fechaTermino" name="fechaTermino"
                                               class="form-control" placeholder="DD-MM-YYYY HH:mm:ss"
                                               value="{{ fechaTermino }}">
                                        <span class="input-group-text">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="tipoEvento" class="form-label">Tipo de Evento</label>
                                    <select class="form-select" id="tipoEvento" name="tipoEvento[]" multiple>
                                        <option value="all">Todos</option>
                                        <option value="alarm">Alarma</option>
                                        <option value="warning">Advertencia</option>
                                        <option value="info">Información</option>
                                        <option value="error">Error</option>
                                        <option value="critical">Crítico</option>
                                    </select>
                                    <small class="text-muted">Ctrl+Click para selección múltiple</small>
                                </div>
                            </div>

                            <div class="col-md-3 d-flex align-items-end">
                                <div class="w-100 mb-3">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <label for="dispositivo" class="form-label">Dispositivo</label>
                                <select class="form-select" id="dispositivo" name="dispositivo">
                                    <option value="">Todos los dispositivos</option>
                                    <option value="PLC-01">PLC-01</option>
                                    <option value="PLC-02">PLC-02</option>
                                    <option value="RTU-01">RTU-01</option>
                                    <option value="RTU-02">RTU-02</option>
                                    <option value="SCADA-MASTER">SCADA Master</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="severidad" class="form-label">Severidad</label>
                                <select class="form-select" id="severidad" name="severidad">
                                    <option value="">Todas</option>
                                    <option value="high">Alta</option>
                                    <option value="medium">Media</option>
                                    <option value="low">Baja</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="rowsPerPage" class="form-label">Filas por página</label>
                                <select class="form-select" id="rowsPerPage" name="rowsPerPage">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="500" selected>500</option>
                                    <option value="1000">1000</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Actualización Automática</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="actualizacionAutomatica" checked>
                                    <label class="form-check-label" for="actualizacionAutomatica">
                                        Activada
                                    </label>
                                </div>

                                <div class="mt-2">
                                    <label for="timer-range-ajax-update" class="form-label">
                                        <i class="fas fa-clock"></i> Intervalo (seg)
                                    </label>
                                    <input type="number" class="form-control" id="timer-range-ajax-update"
                                           min="5" max="180" value="30" step="5">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Toolbar de acciones -->
        <div class="btn-toolbar mb-3" role="toolbar">
            <div class="btn-group me-2" role="group">
                <button class="btn btn-info" type="button">
                    Total registros: <span class="badge bg-light text-dark">{{ data_table|length|default(0) }}</span>
                </button>
                <button type="button" class="btn btn-success" onclick="getBitacoraData()">
                    <i class="fas fa-sync"></i> Actualizar
                </button>
                <button type="button" class="btn btn-warning" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button type="button" class="btn btn-danger" onclick="downloadBitacora()">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button type="button" class="btn btn-primary" onclick="addEntry()">
                    <i class="fas fa-plus-circle"></i> Nueva Entrada
                </button>
            </div>
        </div>

        <!-- Tabla de datos -->
        <div id="bitacora_table_container">
            {% if data_table is defined and data_table|length > 0 %}
                <div class="table-responsive">
                    <table id="tbl_bitacora" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha/Hora</th>
                                <th>Dispositivo</th>
                                <th>Tipo Evento</th>
                                <th>Descripción</th>
                                <th>Valor</th>
                                <th>Severidad</th>
                                <th>Usuario</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data_table %}
                                <tr>
                                    <td>{{ row.id|default('-') }}</td>
                                    <td>{{ row.fecha_hora|default('-') }}</td>
                                    <td>{{ row.dispositivo|default('-') }}</td>
                                    <td>
                                        {% set event_icon = 'info-circle' %}
                                        {% set event_color = 'info' %}
                                        {% if row.tipo_evento == 'alarm' %}
                                            {% set event_icon = 'bell' %}
                                            {% set event_color = 'warning' %}
                                        {% elseif row.tipo_evento == 'error' %}
                                            {% set event_icon = 'exclamation-triangle' %}
                                            {% set event_color = 'danger' %}
                                        {% elseif row.tipo_evento == 'critical' %}
                                            {% set event_icon = 'exclamation-circle' %}
                                            {% set event_color = 'danger' %}
                                        {% endif %}
                                        <i class="fas fa-{{ event_icon }} text-{{ event_color }}"></i>
                                        {{ row.tipo_evento|default('-') }}
                                    </td>
                                    <td>{{ row.descripcion|default('-') }}</td>
                                    <td>{{ row.valor|default('-') }}</td>
                                    <td>
                                        {% set severity_class = '' %}
                                        {% if row.severidad == 'high' %}
                                            {% set severity_class = 'severity-high' %}
                                        {% elseif row.severidad == 'medium' %}
                                            {% set severity_class = 'severity-medium' %}
                                        {% elseif row.severidad == 'low' %}
                                            {% set severity_class = 'severity-low' %}
                                        {% endif %}
                                        <span class="badge {{ severity_class }}">
                                            {{ row.severidad|default('normal')|upper }}
                                        </span>
                                    </td>
                                    <td>{{ row.usuario|default('Sistema') }}</td>
                                    <td>
                                        {% if row.estado == 'resuelto' %}
                                            <span class="badge bg-success">Resuelto</span>
                                        {% elseif row.estado == 'pendiente' %}
                                            <span class="badge bg-warning">Pendiente</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ row.estado|default('Activo') }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" onclick="viewEntry({{ row.id }})" title="Ver detalle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" onclick="acknowledgeEntry({{ row.id }})" title="Reconocer">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="addComment({{ row.id }})" title="Agregar comentario">
                                                <i class="fas fa-comment"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>No se encontraron entradas en la bitácora</h5>
                    <p>Ajuste los filtros de búsqueda para ver los registros</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        var timer_interval;

        function getBitacoraData() {
            var data = {
                fechaInicio: $('#fechaInicio').val(),
                fechaTermino: $('#fechaTermino').val(),
                tipoEvento: $('#tipoEvento').val(),
                dispositivo: $('#dispositivo').val(),
                severidad: $('#severidad').val(),
                rowsPerPage: $('#rowsPerPage').val()
            };

            $('#bitacora_table_container').html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Cargando datos...</div>');

            $.ajax({
                url: "{{ path('siv_dashboard_bitacora') }}",
                type: "GET",
                data: data,
                success: function (response) {
                    location.reload();
                },
                error: function() {
                    $('#bitacora_table_container').html('<div class="alert alert-danger">Error al cargar los datos</div>');
                }
            });
        }

        function SetBitacoraTimer() {
            var interval = $('#timer-range-ajax-update').val() * 1000;

            timer_interval = setInterval(function () {
                if($('#actualizacionAutomatica').is(":checked")) {
                    getBitacoraData();
                }
            }, interval);
        }

        function addEntry() {
            alert('Función para agregar entrada a la bitácora');
        }

        function viewEntry(id) {
            alert('Ver detalle de entrada ID: ' + id);
        }

        function acknowledgeEntry(id) {
            if(confirm('¿Reconocer esta entrada?')) {
                alert('Reconocer entrada ID: ' + id);
            }
        }

        function addComment(id) {
            var comment = prompt('Ingrese su comentario:');
            if(comment) {
                alert('Agregar comentario a entrada ID: ' + id + '\nComentario: ' + comment);
            }
        }

        function exportExcel() {
            alert('Exportar a Excel');
        }

        function downloadBitacora() {
            window.print();
        }

        $(document).ready(function() {
            SetBitacoraTimer();

            $('#timer-range-ajax-update').on('change', function() {
                clearInterval(timer_interval);
                SetBitacoraTimer();
            });

            // Resaltar filas con severidad alta
            $('tr:has(.severity-high)').addClass('table-danger');
            $('tr:has(.severity-medium)').addClass('table-warning');
        });
    </script>
{% endblock %}