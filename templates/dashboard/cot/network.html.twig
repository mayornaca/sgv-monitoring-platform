{% extends '@EasyAdmin/page/content.html.twig' %}

{% block title %}Diagrama de Red - COT{% endblock %}

{% block page_title %}
    <i class="fas fa-project-diagram"></i> Diagrama de Red - COT
{% endblock %}

{% block head_stylesheets %}
    {{ parent() }}
    <style>
        .network-container {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .network-controls {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .device-status-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .alarm-sidebar {
            max-height: 600px;
            overflow-y: auto;
        }
        .alarm-item {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #ffc107;
            background: #fff;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .alarm-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #networkDiagram {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #fafafa;
        }
        .network-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        .stat-card.danger {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
    </style>
{% endblock %}

{% block head_javascript %}
    {{ parent() }}
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script>
{% endblock %}

{% block body %}
    <div class="content-wrapper">
        <!-- Estadísticas de Red -->
        <div class="network-stats">
            <div class="stat-card success">
                <div class="stat-number">
                    {% set active_devices = 0 %}
                    {% if json_graphic_template is defined %}
                        {% set active_devices = json_graphic_template|split('"color":"#00de2a"')|length - 1 %}
                    {% endif %}
                    {{ active_devices }}
                </div>
                <div class="stat-label">Dispositivos Activos</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-number">
                    {% set inactive_devices = 0 %}
                    {% if json_graphic_template is defined %}
                        {% set inactive_devices = json_graphic_template|split('"color":"#de0000"')|length - 1 %}
                    {% endif %}
                    {{ inactive_devices }}
                </div>
                <div class="stat-label">Dispositivos Inactivos</div>
            </div>
            <div class="stat-card info">
                <div class="stat-number">
                    {% set total_links = 0 %}
                    {% if json_graphic_template is defined %}
                        {% set total_links = json_graphic_template|split('"from":')|length - 1 %}
                    {% endif %}
                    {{ total_links }}
                </div>
                <div class="stat-label">Enlaces de Red</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ alarmas_dispositivos|length|default(0) }}</div>
                <div class="stat-label">Alarmas Activas</div>
            </div>
        </div>

        <div class="row">
            <!-- Diagrama Principal -->
            <div class="col-lg-9">
                <div class="network-container">
                    <!-- Controles del Diagrama -->
                    <div class="network-controls">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h4 class="mb-0">
                                    <i class="fas fa-project-diagram"></i> Topología de Red
                                </h4>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomToFit()">
                                        <i class="fas fa-compress"></i> Ajustar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomIn()">
                                        <i class="fas fa-search-plus"></i> Zoom +
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomOut()">
                                        <i class="fas fa-search-minus"></i> Zoom -
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="refreshDiagram()">
                                        <i class="fas fa-sync-alt"></i> Actualizar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="exportDiagram()">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Leyenda -->
                    <div class="device-status-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00de2a;"></div>
                            <span>Dispositivo Activo</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #de0000;"></div>
                            <span>Dispositivo Inactivo</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffc107;"></div>
                            <span>Enlace Primario</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #1976d2;"></div>
                            <span>Enlace Secundario</span>
                        </div>
                        <div class="legend-item">
                            <div style="width: 40px; height: 2px; background: repeating-linear-gradient(90deg, #333 0, #333 5px, transparent 5px, transparent 10px);"></div>
                            <span>RPL Link</span>
                        </div>
                    </div>

                    <!-- Diagrama GoJS -->
                    <div id="networkDiagram"></div>
                </div>
            </div>

            <!-- Panel de Alarmas -->
            <div class="col-lg-3">
                <div class="network-container">
                    <h5 class="mb-3">
                        <i class="fas fa-bell text-warning"></i> 
                        Alarmas de Red
                        <span class="badge bg-warning">{{ alarmas_dispositivos|length|default(0) }}</span>
                    </h5>
                    
                    <div class="alarm-sidebar">
                        {% if alarmas_dispositivos is defined and alarmas_dispositivos|length > 0 %}
                            {% for alarma in alarmas_dispositivos|slice(0, 10) %}
                            <div class="alarm-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge bg-warning">ID: {{ alarma.id }}</span>
                                    <small class="text-muted">Hace 5 min</small>
                                </div>
                                
                                {% if alarma.idDispositivo is defined %}
                                <h6 class="mb-1">
                                    <i class="fas fa-server"></i> 
                                    {{ alarma.idDispositivo.nombre|default('Dispositivo') }}
                                </h6>
                                {% if alarma.idDispositivo.ip is defined %}
                                <small class="text-muted d-block mb-2">
                                    IP: {{ alarma.idDispositivo.ip }}
                                </small>
                                {% endif %}
                                {% endif %}
                                
                                {% if alarma.idAlarma is defined %}
                                <p class="mb-2 small">
                                    {{ alarma.idAlarma.alarma|default('Sin descripción') }}
                                </p>
                                {% endif %}
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-fill">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-sm btn-outline-success flex-fill">
                                        <i class="fas fa-check"></i> Resolver
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if alarmas_dispositivos|length > 10 %}
                            <div class="text-center mt-3">
                                <a href="#" class="btn btn-sm btn-outline-primary">
                                    Ver todas ({{ alarmas_dispositivos|length }})
                                </a>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                Sin alarmas en la red
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Información de Red -->
                <div class="network-container mt-3">
                    <h5 class="mb-3">
                        <i class="fas fa-info-circle"></i> Información de Red
                    </h5>
                    <dl class="row small">
                        <dt class="col-6">Anillo Principal:</dt>
                        <dd class="col-6">ERPS ID 1</dd>
                        
                        <dt class="col-6">Sub Anillo 1:</dt>
                        <dd class="col-6">ERPS ID 2</dd>
                        
                        <dt class="col-6">Sub Anillo 2:</dt>
                        <dd class="col-6">ERPS ID 3</dd>
                        
                        <dt class="col-6">Última Actualización:</dt>
                        <dd class="col-6">{{ "now"|date("H:i:s") }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para GoJS -->
    <script>
        var networkDiagram;
        
        function init() {
            var $ = go.GraphObject.make;
            
            networkDiagram = $(go.Diagram, "networkDiagram", {
                initialContentAlignment: go.Spot.Center,
                "undoManager.isEnabled": true,
                "animationManager.isEnabled": true,
                layout: $(go.ForceDirectedLayout, {
                    maxIterations: 200,
                    defaultSpringLength: 30,
                    defaultElectricalCharge: 100
                })
            });

            // Template para nodos
            networkDiagram.nodeTemplate = $(go.Node, "Auto",
                {
                    locationSpot: go.Spot.Center,
                    cursor: "pointer"
                },
                new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                $(go.Shape, "RoundedRectangle",
                    { strokeWidth: 2, stroke: "#555", fill: "white" },
                    new go.Binding("fill", "color"),
                    new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify)
                ),
                $(go.TextBlock,
                    { margin: 8, font: "bold 11px sans-serif", textAlign: "center" },
                    new go.Binding("text", "name")
                ),
                {
                    toolTip: $(go.Adornment, "Auto",
                        $(go.Shape, { fill: "#FFFFCC" }),
                        $(go.TextBlock, { margin: 4 },
                            new go.Binding("text", "", function(data) {
                                return "Dispositivo: " + data.name + "\nEstado: " + 
                                    (data.color === "#00de2a" ? "Activo" : "Inactivo");
                            })
                        )
                    )
                }
            );

            // Template para enlaces
            networkDiagram.linkTemplate = $(go.Link,
                {
                    routing: go.Link.AvoidsNodes,
                    curve: go.Link.JumpOver,
                    corner: 5,
                    toShortLength: 4
                },
                new go.Binding("points"),
                $(go.Shape,
                    { strokeWidth: 2, stroke: "#555" },
                    new go.Binding("stroke", "color"),
                    new go.Binding("strokeDashArray", "dash")
                ),
                $(go.Shape,
                    { toArrow: "Standard", stroke: null },
                    new go.Binding("fill", "color")
                ),
                $(go.Panel, "Auto",
                    { visible: false },
                    new go.Binding("visible", "text", function(t) { return t !== ""; }),
                    $(go.Shape, "RoundedRectangle",
                        { fill: "#FFFFCC", stroke: "#555" }
                    ),
                    $(go.TextBlock,
                        { margin: 3, font: "9px sans-serif" },
                        new go.Binding("text", "text")
                    )
                )
            );

            // Cargar datos del diagrama
            {% if json_graphic_template is defined %}
            var modelData = {{ json_graphic_template|raw }};
            networkDiagram.model = go.Model.fromJson(JSON.stringify(modelData));
            {% endif %}
        }

        // Funciones de control
        function zoomToFit() {
            networkDiagram.commandHandler.zoomToFit();
        }

        function zoomIn() {
            networkDiagram.commandHandler.increaseZoom();
        }

        function zoomOut() {
            networkDiagram.commandHandler.decreaseZoom();
        }

        function refreshDiagram() {
            location.reload();
        }

        function exportDiagram() {
            var img = networkDiagram.makeImage({
                scale: 2,
                background: "white"
            });
            var link = document.createElement('a');
            link.download = 'network-diagram-' + new Date().getTime() + '.png';
            link.href = img.src;
            link.click();
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);

        // Auto-refresh cada 60 segundos
        setTimeout(function() {
            location.reload();
        }, 60000);
    </script>
{% endblock %}